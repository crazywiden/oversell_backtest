# Frontend Visualization Plan v1: Self-Contained HTML Backtest Report

**Author:** Frontend Planner (Design Mode)
**Date:** 2026-02-24
**Status:** Draft

---

## 1. Overview

This document specifies the design for a self-contained HTML5 report generated by the
oversell backtesting engine. The report is a single `.html` file written to
`results/{run_id}/report.html`. It can be opened by double-clicking in any modern
browser with no local server required.

**Technology choices:**
- Plotly.js via CDN (`https://cdn.plot.ly/plotly-2.35.2.min.js`) for interactive charts
- Vanilla JavaScript for table filtering/sorting (zero dependencies)
- Inline CSS (no external stylesheets)
- Python string templating with sentinel `__PLACEHOLDER__` strings to avoid brace conflicts with CSS/JS

**Explicitly excluded:** React, npm, build steps, local asset files.

---

## 2. Input Data Contracts

### 2.1 `trades_df` (pandas DataFrame)

Every row is one trade fill event (BUY or SELL).

| Column         | dtype      | Description                                  | Present on |
|----------------|------------|----------------------------------------------|------------|
| `date`         | str (YYYY-MM-DD) | Trade execution date                   | BUY, SELL  |
| `action`       | str        | `"buy"` or `"sell"`                          | BUY, SELL  |
| `ticker`       | str        | Stock ticker symbol                          | BUY, SELL  |
| `company_name` | str        | Full company name                            | BUY, SELL  |
| `industry`     | str        | Industry classification                      | BUY, SELL  |
| `price`        | float      | Execution price                              | BUY, SELL  |
| `r_prev`       | float      | r_{T-1} at time of buy decision (decimal)    | BUY, SELL  |
| `v_prev`       | float      | v_{T-1} at time of buy decision (raw volume) | BUY, SELL  |
| `dr_prev`      | float      | D(r)_{T-1} z-score                           | BUY, SELL  |
| `dv_prev`      | float      | D(v)_{T-1} z-score                           | BUY, SELL  |
| `os_prev`      | float      | OS_{T-1} score                               | BUY, SELL  |
| `hold_days`    | int or NaN | Trading days held                            | SELL only  |
| `exit_type`    | str or NaN | `"stop_loss"`, `"take_profit"`, `"max_hold"` | SELL only  |

### 2.2 `portfolio_df` (pandas DataFrame)

| Column          | dtype      | Description                                |
|-----------------|------------|--------------------------------------------|
| `date`          | str (YYYY-MM-DD) | Trading date                          |
| `total_value`   | float      | End-of-day portfolio value in USD          |
| `daily_return`  | float      | Daily return as decimal (e.g., 0.012)      |
| `cumulative_return` | float  | Cumulative return from start               |

### 2.3 `config` (dict)

```python
{
    "run_id": str,
    "start_date": str,      # YYYY-MM-DD
    "end_date": str,        # YYYY-MM-DD
    "initial_capital": float,
    "strategy_name": str,
}
```

---

## 3. ASCII Layout — Full Report Page

```
+======================================================================+
|                                                                      |
|  OVERSELL BACKTEST REPORT                                            |
|  Strategy: {strategy_name}                                           |
|  Period: {start_date} — {end_date}   |   Run: {run_id}              |
|                                                                      |
+======================================================================+
|                                                                      |
|  SECTION 1: SUMMARY METRICS                                         |
|                                                                      |
|  +------------------+  +------------------+  +------------------+    |
|  |  TOTAL RETURN    |  |  SHARPE RATIO    |  |  MAX DRAWDOWN    |   |
|  |    +24.57%       |  |     1.83         |  |     -8.42%       |   |
|  +------------------+  +------------------+  +------------------+    |
|                                                                      |
+----------------------------------------------------------------------+
|  SECTION 2: DAILY RETURN CURVE              [Plotly interactive]     |
|  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     |
|  |  .  .          .                                             |     |
|  | . .. .  .  .  . .                                           |     |
|  |----0%------------------------------------                   |     |
|  |         . ..  .     .   . .                                 |     |
|  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     |
+----------------------------------------------------------------------+
|  SECTION 3: TOTAL ASSET CURVE               [Plotly interactive]     |
|  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     |
|  |                                        ___/                  |     |
|  |                           ____/---___/                       |     |
|  |              ____/---___/                                    |     |
|  | Initial cap ____________                                     |     |
|  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     |
+----------------------------------------------------------------------+
|  SECTION 4: TRADE LOG                                                |
|                                                                      |
|  Filters: [Ticker: ___] [Action: ALL v] [Exit Type: ALL v]          |
|  Showing 142 of 248 trades                                           |
|                                                                      |
|  | Date  |Act |Ticker|Company |Industry|Price|r  |v  |Dr|Dv|OS|H|E |
|  | 23-01 |buy |AAPL  |Apple  |ConsElec|182.5|-.03|75M|2.1|1.8|3.9| |  |
|  | 23-03 |sell|AAPL  |Apple  |ConsElec|191.2|    |   |   |   |   |5|TP|  |
|  +--------------------------------------------------------------+  |
|                                                                      |
+----------------------------------------------------------------------+
|  Config: <details> collapsible JSON viewer </details>                |
+======================================================================+
```

---

## 4. HTML Document Structure

Single HTML file assembled by Python using sentinel string replacement. CSS inline, JS inline.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Backtest Report — __RUN_ID__</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        /* Dark slate color scheme (~80 lines) */
        :root { --bg: #0f172a; --card: #1e293b; --green: #22c55e; --red: #ef4444; --blue: #3b82f6; }
        body { background: var(--bg); color: #f1f5f9; font-family: sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .metrics-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 16px; margin: 20px 0; }
        .metric-card { background: var(--card); padding: 24px; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 2rem; font-weight: 700; font-family: monospace; }
        /* table, filter, badge styles ... */
    </style>
</head>
<body>
    <h1>Oversell Backtest Report</h1>
    <p>Run: __RUN_ID__ | Period: __START_DATE__ — __END_DATE__ | Generated: __GENERATED_AT__</p>

    <section><!-- Summary Metrics --></section>
    <section><div id="chart-daily-return"></div></section>
    <section><div id="chart-total-asset"></div></section>
    <section>
        <!-- Filters -->
        <table id="trades-table"><thead>...</thead><tbody>__TABLE_ROWS__</tbody></table>
    </section>
    <details><summary>Run Configuration</summary><pre>__CONFIG_JSON__</pre></details>

    <script>
        var dailyReturnSpec = __DAILY_RETURN_JSON__;
        var totalAssetSpec = __TOTAL_ASSET_JSON__;
    </script>
    <script>
        Plotly.newPlot('chart-daily-return', dailyReturnSpec.data, dailyReturnSpec.layout, {responsive: true});
        Plotly.newPlot('chart-total-asset', totalAssetSpec.data, totalAssetSpec.layout, {responsive: true});
        // Table filtering + sorting JS (~80 lines)
    </script>
</body>
</html>
```

**Why `__PLACEHOLDER__` instead of `{placeholder}`:** CSS and JS have many `{` and `}` braces. Using sentinel strings avoids conflicts with Python's `str.format()`. The report generator uses `html.replace("__FOO__", value)` for each substitution.

---

## 5. Plotly Chart Configurations

### 5.1 Daily Return Chart

```python
def _build_daily_return_chart(portfolio_df):
    import plotly.graph_objects as go
    fig = go.Figure()
    daily_pct = (portfolio_df["daily_return"] * 100).tolist()
    fig.add_trace(go.Bar(
        x=portfolio_df["date"].tolist(),
        y=daily_pct,
        marker_color=["#22c55e" if r >= 0 else "#ef4444" for r in daily_pct],
        hovertemplate="<b>%{x}</b><br>Daily Return: %{y:.2f}%<extra></extra>",
    ))
    fig.update_layout(
        title="Daily Return (%)", template="plotly_dark", height=350,
        xaxis=dict(type="date", rangeslider=dict(visible=True, thickness=0.05)),
        yaxis=dict(ticksuffix="%", zeroline=True, zerolinewidth=2),
    )
    return fig.to_json()
```

**Bar chart chosen over line chart:** Bar charts are standard for daily return visualization in quant reports — they clearly separate positive/negative days without noisy oscillation.

### 5.2 Total Asset Chart

```python
def _build_total_value_chart(portfolio_df, config):
    import plotly.graph_objects as go
    initial = config.get("initial_capital", 500000)
    fig = go.Figure()
    fig.add_trace(go.Scatter(
        x=portfolio_df["date"].tolist(),
        y=portfolio_df["total_value"].tolist(),
        mode="lines", fill="tozeroy",
        line=dict(color="#3b82f6", width=2),
        fillcolor="rgba(59,130,246,0.1)",
        hovertemplate="<b>%{x}</b><br>Portfolio: $%{y:,.0f}<extra></extra>",
    ))
    # Initial capital reference line
    fig.update_layout(
        shapes=[dict(type="line", x0=portfolio_df["date"].iloc[0], x1=portfolio_df["date"].iloc[-1],
                     y0=initial, y1=initial, line=dict(color="#475569", dash="dash"))],
        title="Portfolio Value ($)", template="plotly_dark", height=350,
        yaxis=dict(tickprefix="$", tickformat=",.0f"),
        xaxis=dict(type="date", rangeslider=dict(visible=True, thickness=0.05)),
    )
    return fig.to_json()
```

---

## 6. Trade Table HTML Structure and JS Filtering

### Filter controls

```html
<div id="trade-filters" style="display:flex; gap:16px; margin-bottom:16px;">
    <input type="text" id="filter-ticker" placeholder="Filter ticker..."
           oninput="applyFilters()" autocomplete="off">
    <select id="filter-action" onchange="applyFilters()">
        <option value="">All Actions</option>
        <option value="buy">BUY</option>
        <option value="sell">SELL</option>
    </select>
    <select id="filter-exit" onchange="applyFilters()">
        <option value="">All Exit Types</option>
        <option value="stop_loss">Stop Loss</option>
        <option value="take_profit">Take Profit</option>
        <option value="max_hold">Max Hold</option>
    </select>
</div>
<div id="trade-count"></div>
```

### `<tr>` structure (generated by Python)

Each row has `data-*` attributes for fast JS filtering:
```html
<tr data-ticker="AAPL" data-action="buy" data-exit="">
    <td>2023-01-15</td><td>buy</td><td>AAPL</td><td>Apple Inc</td>
    <td>Consumer Electronics</td><td>$182.50</td>
    <td>-3.12%</td><td>75,234,100</td><td>2.14</td><td>1.87</td><td>3.92</td>
    <td>--</td><td>--</td>
</tr>
```

### JavaScript filtering (~40 lines)

```javascript
function applyFilters() {
    var ticker = document.getElementById('filter-ticker').value.toUpperCase().trim();
    var action = document.getElementById('filter-action').value;
    var exit = document.getElementById('filter-exit').value;
    var rows = document.querySelectorAll('#trades-table tbody tr');
    var shown = 0;
    for (var i = 0; i < rows.length; i++) {
        var r = rows[i];
        var ok = true;
        if (ticker && r.dataset.ticker.indexOf(ticker) === -1) ok = false;
        if (action && r.dataset.action !== action) ok = false;
        if (exit && r.dataset.exit !== exit) ok = false;
        r.style.display = ok ? '' : 'none';
        if (ok) shown++;
    }
    document.getElementById('trade-count').textContent =
        'Showing ' + shown + ' of ' + rows.length + ' trades';
}
document.addEventListener('DOMContentLoaded', applyFilters);
```

### Column sorting (~30 lines)

Click any `<th class="sortable">` to toggle ascending/descending sort. Reads `data-col` attribute to identify column index. Detects numeric vs string columns via `<th class="num">`. Sorts `<tr>` array and re-appends to `<tbody>`.

---

## 7. Python `generate_report()` Function Design

### Signature

```python
def generate_report(
    trades_df: pd.DataFrame,
    portfolio_df: pd.DataFrame,
    config: dict,
    output_path: str | Path
) -> Path:
    """
    Generate a self-contained HTML backtest report.
    Returns: Path to the written HTML file.
    """
```

### Internal breakdown

```
generate_report()
    |
    +-- _compute_summary_metrics(portfolio_df, config) -> dict
    |       total_return_pct, annualized_sharpe (rf=0), max_drawdown_pct
    |
    +-- _build_daily_return_chart(portfolio_df) -> str (JSON)
    |
    +-- _build_total_value_chart(portfolio_df, config) -> str (JSON)
    |
    +-- _build_trade_table_html(trades_df) -> str (HTML rows)
    |       Formats: price as "$X,XXX.XX", r_prev as "X.XX%",
    |                v_prev as "X,XXX,XXX", scores as "X.XX"
    |                hold_days/exit_type as "--" for BUY rows
    |       html.escape() applied to all string fields
    |
    +-- _render_html(...) -> str
    |       Uses HTML_TEMPLATE string with __PLACEHOLDER__ sentinel replacement
    |
    +-- Path(output_path).parent.mkdir(parents=True, exist_ok=True)
    +-- Path(output_path).write_text(html, encoding="utf-8")
```

### Metrics computation

```python
def _compute_summary_metrics(portfolio_df, config):
    daily_returns = portfolio_df["daily_return"]

    total_return_pct = round(
        (portfolio_df["total_value"].iloc[-1] / config["initial_capital"] - 1) * 100, 2
    )

    std = daily_returns.std()
    sharpe = round((daily_returns.mean() / std) * (252 ** 0.5), 2) if std > 0 else 0.0

    running_max = portfolio_df["total_value"].cummax()
    drawdown = (portfolio_df["total_value"] - running_max) / running_max
    max_dd_pct = round(drawdown.min() * 100, 2)

    return {
        "total_return_pct": total_return_pct,
        "annualized_sharpe": sharpe,
        "max_drawdown_pct": max_dd_pct,
    }
```

### Data embedding strategy

```python
# Python builds Plotly JSON:
daily_return_json = _build_daily_return_chart(portfolio_df)
total_asset_json = _build_total_value_chart(portfolio_df, config)

# In HTML_TEMPLATE:
# var dailyReturnSpec = __DAILY_RETURN_JSON__;
# Plotly.newPlot('chart-daily-return', dailyReturnSpec.data, dailyReturnSpec.layout, ...);

# Substitution:
html = HTML_TEMPLATE
html = html.replace("__DAILY_RETURN_JSON__", daily_return_json)
html = html.replace("__TOTAL_ASSET_JSON__", total_asset_json)
# ... other replacements ...
```

The JSON is injected as a raw JS object literal (no quotes around it), so JavaScript can access `.data` and `.layout` directly without `JSON.parse()`.

---

## 8. File Organization

```
results/
    report.py            # generate_report() + all helpers + HTML_TEMPLATE constant
    __init__.py          # empty
    # Generated run folders (gitignored):
    20260115_143022/
        config.json
        trades.csv
        portfolio.csv
        report.html
```

**One file.** `report.py` contains the HTML template as a multi-line string constant `HTML_TEMPLATE` at the top of the file. No separate template file needed at this scope.

**.gitignore entry:** `results/*/`

---

## 9. Edge Cases

| Scenario | Handling |
|---|---|
| Empty `trades_df` | Show metrics + charts + "No trades" message in table |
| Single-day portfolio | Charts render with single point; Sharpe = 0.0 |
| NaN in `hold_days`/`exit_type` | Display "--" (expected for BUY rows) |
| Non-ASCII company names | `html.escape()` in `_build_trade_table_html()` |
| Plotly CDN unreachable | Charts fail; add `<noscript>` fallback message |

---

## 10. Color Reference

| Element | Color | Hex |
|---|---|---|
| Positive daily return / Sharpe > 1 | Green | `#22c55e` |
| Negative return / Sharpe ≤ 0 | Red | `#ef4444` |
| Portfolio value line | Blue | `#3b82f6` |
| take_profit exit | Green | `#22c55e` |
| stop_loss exit | Red | `#ef4444` |
| max_hold exit | Gray | `#94a3b8` |
| Body background | Dark slate | `#0f172a` |
| Card/chart background | Mid slate | `#1e293b` |

---

## 11. Implementation Checklist

### Phase 1: Scaffolding
- [ ] Create `results/__init__.py` (empty)
- [ ] Create `results/report.py` with `generate_report()` signature + `HTML_TEMPLATE` constant

### Phase 2: Metrics
- [ ] Implement `_compute_summary_metrics()` (total return, Sharpe, max drawdown)
- [ ] Unit test: known inputs → expected metric values

### Phase 3: Charts
- [ ] Implement `_build_daily_return_chart()` (Plotly bar chart JSON)
- [ ] Implement `_build_total_value_chart()` (Plotly scatter+area JSON with reference line)

### Phase 4: Trade Table
- [ ] Implement `_build_trade_table_html()` with formatting, data-* attributes, html.escape()
- [ ] Unit test: BUY rows show "--" for hold_days/exit_type; SELL rows show values

### Phase 5: Assembly
- [ ] Implement `_render_html()` with all `__PLACEHOLDER__` substitutions
- [ ] Wire up full `generate_report()` pipeline
- [ ] Generate report with fake data and open in browser

### Phase 6: Interactivity verification
- [ ] Plotly charts render (requires CDN access)
- [ ] Ticker filter works (partial, case-insensitive)
- [ ] Action and exit type dropdowns filter correctly
- [ ] Column sorting works for date, ticker, price, and numeric columns
- [ ] Trade count label updates on filter change
- [ ] Test in Chrome, Firefox, Safari

### Phase 7: Dependencies
- [ ] Add `plotly` to `requirements.txt`
- [ ] Pin Plotly.js CDN version in HTML template
